/* =========================================
   ДОБАВЛЕНИЕ НОВЫХ ТАБЛИЦ
========================================= */
USE OptStroySistem;
GO

/* =========================================
   ТАБЛИЦА КАТЕГОРИЙ
   (Иерархия для структурирования товаров)
========================================= */
CREATE TABLE Categories (
    CategoryID INT IDENTITY PRIMARY KEY,
    ParentCategoryID INT NULL,
    Name NVARCHAR(100) NOT NULL UNIQUE,
    Description NVARCHAR(500) NULL,
    
    CONSTRAINT FK_Categories_ParentCategory FOREIGN KEY (ParentCategoryID)
        REFERENCES Categories(CategoryID)
);
GO

-- Добавляем столбец CategoryID в таблицу Products
ALTER TABLE Products
ADD CategoryID INT NULL;

-- Создаем внешний ключ после добавления столбца
ALTER TABLE Products
ADD CONSTRAINT FK_Products_Categories FOREIGN KEY (CategoryID)
    REFERENCES Categories(CategoryID);
GO

/* =========================================
   ТАБЛИЦА ОСТАТКОВ НА СКЛАДЕ
   (Управление доступным количеством товара)
========================================= */
CREATE TABLE Stock (
    StockID INT IDENTITY PRIMARY KEY,
    ProductID INT NOT NULL UNIQUE, -- Один товар - одна запись об остатке
    Quantity INT NOT NULL DEFAULT 0,
    LastUpdated NVARCHAR(50) NOT NULL,
    MinimumThreshold INT NOT NULL DEFAULT 5, -- Минимальный порог для заказа
    
    CONSTRAINT FK_Stock_Products FOREIGN KEY (ProductID)
        REFERENCES Products(ProductID)
        ON DELETE CASCADE
);
GO

/* =========================================
   ТАБЛИЦА ИЗБРАННЫХ ТОВАРОВ (СПИСОК ЖЕЛАНИЙ)
   (Позволяет пользователям сохранять товары для будущего)
========================================= */
CREATE TABLE Wishlist (
    WishlistItemID INT IDENTITY PRIMARY KEY,
    UserID INT NOT NULL,
    ProductID INT NOT NULL,
    AddedAt NVARCHAR(50) NOT NULL,
    
    CONSTRAINT FK_Wishlist_Users FOREIGN KEY (UserID)
        REFERENCES Users(UserID)
        ON DELETE CASCADE,
    
    CONSTRAINT FK_Wishlist_Products FOREIGN KEY (ProductID)
        REFERENCES Products(ProductID)
        ON DELETE CASCADE,
    
    CONSTRAINT UQ_User_Product UNIQUE (UserID, ProductID) -- Один товар в избранном у пользователя
);
GO

/* =========================================
   ТАБЛИЦА ОТЗЫВОВ НА ТОВАРЫ
   (Отзывы только от пользователей, которые покупали товар)
========================================= */
CREATE TABLE ProductReviews (
    ReviewID INT IDENTITY PRIMARY KEY,
    OrderItemID INT NOT NULL, -- Связь через купленный товар в заказе
    UserID INT NOT NULL,
    ProductID INT NOT NULL,
    Rating INT NOT NULL CHECK (Rating >= 1 AND Rating <= 5), -- Оценка от 1 до 5
    Comment NVARCHAR(1000) NULL,
    ReviewDate NVARCHAR(50) NOT NULL,
    IsApproved INT NOT NULL DEFAULT 0, -- Модерация отзыва
    
    CONSTRAINT FK_ProductReviews_OrderItems FOREIGN KEY (OrderItemID)
        REFERENCES OrderItems(OrderItemID),
    
    CONSTRAINT FK_ProductReviews_Users FOREIGN KEY (UserID)
        REFERENCES Users(UserID),
    
    CONSTRAINT FK_ProductReviews_Products FOREIGN KEY (ProductID)
        REFERENCES Products(ProductID),
    
    CONSTRAINT UQ_OrderItem_Review UNIQUE (OrderItemID) -- Один отзыв на одну позицию заказа
);
GO

-- Добавляем индекс для быстрого поиска отзывов по товару
CREATE INDEX IX_ProductReviews_ProductID ON ProductReviews(ProductID);
GO

/* =========================================
   ДОПОЛНИТЕЛЬНЫЙ ИНДЕКС ДЛЯ ОПТИМИЗАЦИИ
========================================= */
CREATE INDEX IX_Products_CategoryID ON Products(CategoryID);
GO